---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(pagoda2)
library(conos)
library(tidyverse)
library(magrittr)
library(igraph)
library(ggpubr)
```
```{r}
findCells <- function(sample, k = 0.05){
  #k <- dim(sample$reductions$PCA)[1]*per
  n.cells <-  round(dim(sample$reductions$PCA)[1]*k)
  mat <- conos:::getNeighborMatrix(p1 = sample$reductions$PCA, p2=NULL, k = n.cells, matching = "NN")
  colnames(mat) <- rownames(sample$reductions$PCA)
  rownames(mat) <- rownames(sample$reductions$PCA)
  num.elements <- colSums(mat!=0)
  cell.distance <- mat@x
  list.cell <- list()
  j <- 1
  for (i in 1:dim(mat)[1]){
    sep <-num.elements[i]  
    cells <- setNames(cell.distance[j:(sep+j-1)], colnames(mat)[mat@i[j:(sep+j-1)]+1])
    cells <- cells[order(cells, decreasing = T)[1:n.cells]]
    list.cell <- c(list.cell, list(cells))
    j <- j + sep
  }
  names(list.cell) <- colnames(mat)
  #sample$misc <- list.cell
  return(list.cell)
}

```



```{r, fig.width = 8}
pan.tiny <- readRDS(file = "/home/kvergasova/conos_analysis/data_tiny.rds")
#pan.b <- readRDS(file = "data_big.rds")
# pan.b <- readRDS(file = "data_big.rds")
cono.t <- Conos$new(pan.tiny)
p.conos.old <- list()

cono.t$misc <- NULL
cono.t$misc$neighborfilter <- NULL
cono.t$misc$add.cells <- TRUE
cono.t$misc$add.cells.k <- 2
cono.t$misc$add.cells.times <- 1
# debug(cono.t$buildGraph)
cono.t$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = 0)
cono.t$findCommunities(method=leiden.community, resolution=1)
cono.t$embedGraph()
cono.t$plotGraph(color.by='sample', mark.groups=FALSE,  alpha=0.1, show.legend=TRUE)
```


```{r, fig.width = 8}
cells_with_no_neig <- cono.t$misc$cells.zero[[1]]
#cono.t$misc$cells.add.to.zero
cells_add_to_zero <- unlist(setdiff(cono.t$misc$cells.add.to.zero, cells_with_no_neig))

cell_lab <- rownames(cono.t$embedding)
names(cell_lab) <- rownames(cono.t$embedding)
#cell_lab <- "n"
cell_lab[names(cell_lab) %in% cells_with_no_neig] <- "нет соседей"
cell_lab[names(cell_lab) %in% cells_add_to_zero] <- "добавленные соседи"
cell_lab[!cell_lab %in% c("нет соседей", "добавленные соседи")] <- "соседи есть"

cono.t$plotGraph(groups=cell_lab, alpha=0.1, show.legend=TRUE)
cono.t$plotGraph(color.by='sample', alpha=0.1, show.legend=TRUE)
```


```{r, fig.width = 8}
ann.tiny <- fread("/home/kvergasova/conos_analysis/annotation_tiny_data.tsv")

#делаю цикл более 1 раза
cono.t$misc$neighborfilter <- NULL
cono.t$misc$add.cells <- TRUE
cono.t$misc$add.cells.k <- 2
cono.t$misc$add.cells.times <- 2
cono.t$buildGraph(k=30, k1 = 50, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = 0)

cono.t$findCommunities(method=leiden.community, resolution=1)
cono.t$embedGraph()
cells_with_no_neig <- cono.t$misc$cells.zero[[2]]
cells_add_to_zero <- setdiff(cells_add_to_zero, cells_with_no_neig[[2]])

cell_lab <- rownames(cono.t$embedding)
names(cell_lab) <- rownames(cono.t$embedding)
#cell_lab <- "n"
cell_lab[names(cell_lab) %in% cells_with_no_neig[[2]]] <- "no_neig"
cell_lab[names(cell_lab) %in% cells_add_to_zero] <- "add_cells"
cell_lab[!cell_lab %in% c("no_neig", "add_cells")] <- "no_i"

cono.t$plotGraph(groups=cell_lab, alpha=0.1, show.legend=TRUE)
cono.t$plotGraph(color.by='sample', alpha=0.1, show.legend=TRUE)
```


```{r, fig.width = 8}
ann.tiny1 <- fread("/home/kvergasova/conos_analysis/annotation_tiny_data.tsv")
g <- cono.t$graph
batch <- tibble(cell = names(V(g)))  
batch <- left_join(batch, ann.tiny1, by = "cell")

modularity(g, as.numeric(as.factor(batch$protocol)))
modularity(g, as.numeric(as.factor(batch$cellType)))
```


```{r, fig.width = 8}
prot <- c( -0.01675243, -0.1836122)
cell <- c(0.4844675, 0.3035448)
nam <- c("без изменений", "добавление соседей")
df.plot <- tibble(nam, prot, cell)

ggplot(df.plot, aes(x = nam, group = 1)) + geom_line(aes(y = cell, color = 'клеточные типы'), color = 'green')+ geom_point(aes(y = cell), color = 'green')+ geom_line(aes(y = prot, color = 'протокол'), color = 'blue') + geom_point(aes(y = prot), color = 'blue') + ylab('модулярность') +  theme_bw() + theme(text = element_text(size=20))
```

