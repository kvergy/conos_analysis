---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(pagoda2)
library(conos)
library(tidyverse)
library(magrittr)
library(igraph)
library(ggpubr)
```
```{r}
findCells <- function(sample, k = 0.05){
  #k <- dim(sample$reductions$PCA)[1]*per
  n.cells <-  round(dim(sample$reductions$PCA)[1]*k)
  mat <- conos:::getNeighborMatrix(p1 = sample$reductions$PCA, p2=NULL, k = n.cells, matching = "NN")
  colnames(mat) <- rownames(sample$reductions$PCA)
  rownames(mat) <- rownames(sample$reductions$PCA)
  num.elements <- colSums(mat!=0)
  cell.distance <- mat@x
  list.cell <- list()
  j <- 1
  for (i in 1:dim(mat)[1]){
    sep <-num.elements[i]  
    cells <- setNames(cell.distance[j:(sep+j-1)], colnames(mat)[mat@i[j:(sep+j-1)]+1])
    cells <- cells[order(cells, decreasing = T)[1:n.cells]]
    list.cell <- c(list.cell, list(cells))
    j <- j + sep
  }
  names(list.cell) <- colnames(mat)
  #sample$misc <- list.cell
  return(list.cell)
}

```
```{r}
pan.tiny <- readRDS(file = "data_tiny.rds")
pan.b <- readRDS(file = "data_big.rds")
# pan.b <- readRDS(file = "data_big.rds")
cono.t <- Conos$new(pan.tiny)
# cono.b <- Conos$new(pan.b)
cono.t$misc <- lapply(cono.t$samples, function(x) findCells(x, 0.05))
cono.t$misc$add.cells <- TRUE
# cono.b$mispan.tiny <- readRDS(file = "data_tiny.rds")
#c <- lapply(cono.b$samples, function(x) findCells(x, 0.1))
#cell.names <- lapply(self$samples,getCellNames)
undebug(cono.t$buildGraph)
cono.t$buildGraph(k=30, k1 = 50, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = 0)

cono.t$findCommunities(method=leiden.community, resolution=1)
cono.t$embedGraph()
#cono.tiny$plotGraph(alpha=0.1)
cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
#length(cono.t$misc$tenX$`AAACATTGATCACG-1`)

cono.t$misc$add.cells <- TRUE
cono.t$misc$add.cells.k <- 2
# cono.b$mispan.tiny <- readRDS(file = "data_tiny.rds")
#c <- lapply(cono.b$samples, function(x) findCells(x, 0.1))
#cell.names <- lapply(self$samples,getCellNames)
undebug(cono.t$buildGraph)
cono.t$buildGraph(k=30, k1 = 50, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = 0)

cono.t$findCommunities(method=leiden.community, resolution=1)
cono.t$embedGraph()
#cono.tiny$plotGraph(alpha=0.1)
cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
zero_cells <- read_csv("cells_zero.csv")
all_cells <- unlist(lapply(cono.t$samples,getCellNames))
cells_zero <- as.vector(all_cells) %in% zero_cells$`AAACATTGGAATCC-1`
zer <- setNames(as.factor(as.numeric(cells_zero)), all_cells )
length(zero_cells$`AAACATTGGAATCC-1`)
sum(!cells_zero)
cono.t$plotGraph(groups=zer, mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
```

```{r}
cono.b <- Conos$new(pan.b)
# cono.b <- Conos$new(pan.b)
cono.b$misc <- lapply(cono.b$samples, function(x) findCells(x, 0.05))
cono.b$misc$add.cells <- TRUE
cono.b$misc$add.cells.k <- 1
# cono.b$mispan.tiny <- readRDS(file = "data_tiny.rds")
#c <- lapply(cono.b$samples, function(x) findCells(x, 0.1))
#cell.names <- lapply(self$samples,getCellNames)
#undebug(cono.t$buildGraph)
cono.b$buildGraph(k=30, k1 = 50, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = 0)

cono.b$findCommunities(method=leiden.community, resolution=1)
cono.b$embedGraph()
#cono.tiny$plotGraph(alpha=0.1)
cono.b$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
#length(cono.t$misc$tenX$`AAACATTGATCACG-1`)
```

```{r, fig.width = 8}
pan.tiny <- readRDS(file = "data_tiny.rds")
#pan.b <- readRDS(file = "data_big.rds")
# pan.b <- readRDS(file = "data_big.rds")
cono.t <- Conos$new(pan.tiny)
p.conos.old <- list()
j <- 1
cono.t$misc <- NULL
#cono.t$misc$add.cells <- FALSE

for (i in c(0, 0.1, 0.3, 0.5, 0.8, 1)){
  cono.t$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = i)
  cono.t$findCommunities(method=leiden.community, resolution=1)
  cono.t$embedGraph()
  #cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
  #cono.tiny$plotGraph(alpha=0.1)
  p.conos.old[[j]] <- cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
  j <- j + 1
}
pl.list <- list()
g<-1
for (n.neig in c(0.05, 0.1, 0.3, 0.5)){
  pl <- list()
  j <- 1
  
  cono.t$misc <- lapply(cono.t$samples, function(x) findCells(x, n.neig))
  cono.t$misc$add.cells <- FALSE
  for (i in c(0, 0.1, 0.3, 0.5, 0.8, 1)){
    cono.t$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = i)
    cono.t$findCommunities(method=leiden.community, resolution=1)
    cono.t$embedGraph()
    #cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
    #cono.tiny$plotGraph(alpha=0.1)
    pl[[j]] <- cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
    j <- j + 1
  }
  pl.list[[g]] <- pl
  g <- g+1
}

pl.list[[3]][[1]] + theme(legend.position = "none")
# plot(p.conos.old[[1]])
# plot(p.conos.old[[2]])
# p.conos.old[[3]]
# p.conos.old[[4]]
# p.conos.old[[5]]
# p.conos.old[[6]]
ggarrange(p.conos.old[[1]]+  theme(legend.position = "none"), p.conos.old[[2]]+  theme(legend.position = "none"), p.conos.old[[3]]+  theme(legend.position = "none"), p.conos.old[[4]]+  theme(legend.position = "none"), p.conos.old[[5]]+  theme(legend.position = "none"),p.conos.old[[6]]+  theme(legend.position = "none"),
        pl.list[[1]][[1]] + theme(legend.position = "none"),
        pl.list[[1]][[2]] + theme(legend.position = "none"),
        pl.list[[1]][[3]] + theme(legend.position = "none"),
        pl.list[[1]][[4]] + theme(legend.position = "none"),
        pl.list[[1]][[5]] + theme(legend.position = "none"),
        pl.list[[1]][[6]] + theme(legend.position = "none"),
        pl.list[[2]][[1]] + theme(legend.position = "none"),
        pl.list[[2]][[2]] + theme(legend.position = "none"),
        pl.list[[2]][[3]] + theme(legend.position = "none"),
        pl.list[[2]][[4]] + theme(legend.position = "none"),
        pl.list[[2]][[5]] + theme(legend.position = "none"),
        pl.list[[2]][[6]] + theme(legend.position = "none"),
        pl.list[[3]][[1]] + theme(legend.position = "none"),
        pl.list[[3]][[2]] + theme(legend.position = "none"),
        pl.list[[3]][[3]] + theme(legend.position = "none"),
        pl.list[[3]][[4]] + theme(legend.position = "none"),
        pl.list[[3]][[5]] + theme(legend.position = "none"),
        pl.list[[3]][[6]] + theme(legend.position = "none"),
        pl.list[[4]][[1]] + theme(legend.position = "none"),
        pl.list[[4]][[2]] + theme(legend.position = "none"),
        pl.list[[4]][[3]] + theme(legend.position = "none"),
        pl.list[[4]][[4]] + theme(legend.position = "none"),
        pl.list[[4]][[5]] + theme(legend.position = "none"),
        pl.list[[4]][[6]] + theme(legend.position = "none"),
          ncol = 6, nrow = 5)
#ggarrange(pl[[1]]+ theme(plot.title = element_blank()), pl[[2]] + theme(plot.title = element_blank()), pl[[3]]+ theme(plot.title = element_blank()), pl[[4]]+ theme(plot.title = element_blank()), pl[[5]]+ theme(plot.title = element_blank()), pl2[[1]] + theme(plot.title = element_blank()), pl2[[2]]+ theme(plot.title = element_blank()), pl2[[3]]+ theme(plot.title = element_blank()), pl2[[4]]+ theme(plot.title = element_blank()), pl2[[5]]+ theme(plot.title = element_blank()), pl1[[1]]+theme(plot.title = element_blank()), pl1[[2]]+ theme(plot.title = element_blank()), pl1[[3]]+ theme(plot.title = element_blank()), pl1[[4]]+ theme(plot.title = element_blank()), pl1[[5]]+ theme(plot.title = element_blank()), ncol = 5, nrow = 3)
```
# conos полный датасет
```{r}
p.conos.old <- list()
pan.b <- readRDS(file = "data_big.rds")
# pan.b <- readRDS(file = "data_big.rds")
cono.b <- Conos$new(pan.b)
j <- 1
cono.b$misc <- NULL
cono.b$misc$add.cells <- FALSE

for (i in c(0, 0.1, 0.3, 0.5, 0.8, 1)){
  cono.b$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = i)
  cono.b$findCommunities(method=leiden.community, resolution=1)
  cono.b$embedGraph()
  #cono.b$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
  #cono.biny$plotGraph(alpha=0.1)
  p.conos.old[[j]] <- cono.b$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
  j <- j + 1
}
pl.list <- list()
g<-1
for (n.neig in c(0.05, 0.1, 0.3, 0.5)){
  pl <- list()
  j <- 1
  
  cono.b$misc <- lapply(cono.b$samples, function(x) findCells(x, n.neig))
  cono.b$misc$add.cells <- FALSE
  for (i in c(0, 0.1, 0.3, 0.5, 0.8, 1)){
    cono.b$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = i)
    cono.b$findCommunities(method=leiden.community, resolution=1)
    cono.b$embedGraph()
    #cono.b$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
    #cono.biny$plotGraph(alpha=0.1)
    pl[[j]] <- cono.b$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
    j <- j + 1
  }
  pl.list[[g]] <- pl
  g <- g+1
}

pl.list[[3]][[1]] + theme(legend.position = "none")
# plot(p.conos.old[[1]])
# plot(p.conos.old[[2]])
# p.conos.old[[3]]
# p.conos.old[[4]]
# p.conos.old[[5]]
# p.conos.old[[6]]
ggarrange(p.conos.old[[7]]+  theme(legend.position = "none"), p.conos.old[[8]]+  theme(legend.position = "none"), p.conos.old[[9]]+  theme(legend.position = "none"), p.conos.old[[10]]+  theme(legend.position = "none"), p.conos.old[[11]]+  theme(legend.position = "none"),p.conos.old[[12]]+  theme(legend.position = "none"),
        pl.list[[1]][[1]] + theme(legend.position = "none"),
        pl.list[[1]][[2]] + theme(legend.position = "none"),
        pl.list[[1]][[3]] + theme(legend.position = "none"),
        pl.list[[1]][[4]] + theme(legend.position = "none"),
        pl.list[[1]][[5]] + theme(legend.position = "none"),
        pl.list[[1]][[6]] + theme(legend.position = "none"),
        pl.list[[2]][[1]] + theme(legend.position = "none"),
        pl.list[[2]][[2]] + theme(legend.position = "none"),
        pl.list[[2]][[3]] + theme(legend.position = "none"),
        pl.list[[2]][[4]] + theme(legend.position = "none"),
        pl.list[[2]][[5]] + theme(legend.position = "none"),
        pl.list[[2]][[6]] + theme(legend.position = "none"),
        pl.list[[3]][[1]] + theme(legend.position = "none"),
        pl.list[[3]][[2]] + theme(legend.position = "none"),
        pl.list[[3]][[3]] + theme(legend.position = "none"),
        pl.list[[3]][[4]] + theme(legend.position = "none"),
        pl.list[[3]][[5]] + theme(legend.position = "none"),
        pl.list[[3]][[6]] + theme(legend.position = "none"),
        pl.list[[4]][[1]] + theme(legend.position = "none"),
        pl.list[[4]][[2]] + theme(legend.position = "none"),
        pl.list[[4]][[3]] + theme(legend.position = "none"),
        pl.list[[4]][[4]] + theme(legend.position = "none"),
        pl.list[[4]][[5]] + theme(legend.position = "none"),
        pl.list[[4]][[6]] + theme(legend.position = "none"),
          ncol = 6, nrow = 5)
```
#настраиваю largvis
```{r}
cono.t$misc <- lapply(cono.t$samples, function(x) findCells(x, 0.05))
#cono.t$misc$add.cells <- TRUE
# cono.b$mispan.tiny <- readRDS(file = "data_tiny.rds")
#c <- lapply(cono.b$samples, function(x) findCells(x, 0.1))
#cell.names <- lapply(self$samples,getCellNames)
undebug(cono.t$buildGraph)
cono.t$misc$add.cells <- FALSE
cono.t$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = 0)

cono.t$findCommunities(method=leiden.community, resolution=1)
cono.t$embedGraph( gamma = 1)
#cono.tiny$plotGraph(alpha=0.1)
cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)

cono.t$embedGraph(gamma = 0.2)
#cono.tiny$plotGraph(alpha=0.1)
cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
```

# kbet 
```{r}
9
unique(ann$Protocol)

pan.tiny <- readRDS(file = "data_tiny.rds")
##pan.b <- readRDS(file = "data_big.rds")
# pan.b <- readRDS(file = "data_big.rds")
cono.t <- Conos$new(pan.tiny)
#p.conos.old <- list()
j <- 1
cono.t$misc <- NULL
#cono.t$misc$add.cells <- FALSE
cono.t$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE)
cono.t$findCommunities(method=leiden.community, resolution=1)
cono.t$embedGraph()
# library(FNN)
# get.knn(data, k=k0, algorithm = 'cover_tree')


edge_density(cono.t$graph, loops = FALSE)

neig <- as_adjacency_matrix(cono.t$graph)
df <- tibble(rowSums(neig))
ggplot(df, aes(x = df$`rowSums(neig)`)) + geom_histogram() 



library(kBET)
matrix <- cono.t$embedding
cells <- tibble(cell = rownames(matrix))
annotation <- tibble(cell = names(ann$CellType), cellType = ann$CellType, old_name = ann$CellId, protocol = ann$Protocol)
# нужно переименовать часть клеток
f <- filter(annotation, str_detect(annotation$cell, "-1_GSM"))
f$cell <- strsplit(f$cell, "_GSM") %>% sapply(function(x) x[1])
annotation[str_detect(annotation$cell, "-1_GSM"),] <- f


annotation <- left_join(cells, annotation, by = "cell")
names(annotation$cellType) <- annotation$cell

annotation <- annotation[!duplicated(annotation$cell), ]
#рисунок с аннотацией клеток
cono.t$plotGraph(groups = annotation$cellType, mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
clusters.ann <- names(table(annotation$cellType)[table(annotation$cellType) > 70])
kBET_res <- list()
kBET_result_list <- list()
for (cluster_level in clusters.ann){
   batch_tmp <- annotation$protocol[annotation$cellType == cluster_level]
   data_tmp <- matrix[rownames(matrix) %in%  annotation$cell[annotation$cellType == cluster_level],]
   kBET_tmp <- kBET(df=data_tmp, k0 = 15, batch=batch_tmp, plot=TRUE, do.pca = FALSE,  heuristic=FALSE, adapt=FALSE)
   kBET_result_list[[cluster_level]] <- kBET_tmp
   kBET_res[[cluster_level]] <- kBET_tmp$summary$kBET.observed[1]
}

library(data.table)
save <- tibble(cell = rownames(cono.t$embeddings$largeVis),X = cono.t$embeddings$largeVis[,1], Y = cono.t$embeddings$largeVis[,2] )

fwrite(save, "/home/kvergasova/conos_analysis/tiny_pca.tsv")

all(annotation$cell == save$cell)
fwrite(tibble(unname(annotation$cellType)), "/home/kvergasova/conos_analysis/cell_labels_tiny_data.tsv")
fwrite(tibble(unname(annotation$protocol)), "/home/kvergasova/conos_analysis/protocol_tiny_data.tsv")


# for (i in c(0, 0.1, 0.3, 0.5, 0.8, 1)){
#   cono.t$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = i)
#   cono.t$findCommunities(method=leiden.community, resolution=1)
#   cono.t$embedGraph()
#   #cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
#   #cono.tiny$plotGraph(alpha=0.1)
#   p.conos.old[[j]] <- cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
#   j <- j + 1
# }
```

```{r}
library(conos)
pan.tiny <- readRDS(file = "data_tiny.rds")
#pan.b <- readRDS(file = "data_big.rds")
# pan.b <- readRDS(file = "data_big.rds")
cono.t <- Conos$new(pan.tiny)
#p.conos.old <- list()
j <- 1
cono.t$misc <- NULL
cono.t$misc$neighborfilter <- NULL
cono.t$misc$add.cells <- TRUE
cono.t$misc$add.cells.k <- 2
cono.t$misc$add.cells.times <- 1
# debug(cono.t$buildGraph)
cono.t$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = 0)

cono.t$findCommunities(method=leiden.community, resolution=1)
cono.t$embedGraph()
cono.t$plotGraph(color.by='sample', mark.groups=FALSE,  alpha=0.1, show.legend=TRUE)
cells_with_no_neig <- cono.t$misc$cells.zero[[1]]
cono.t$misc$cells.add.to.zero
cells_add_to_zero <- unlist(setdiff(cono.t$misc$cells.add.to.zero, cells_with_no_neig))

cell_lab <- rownames(cono.t$embedding)
names(cell_lab) <- rownames(cono.t$embedding)
#cell_lab <- "n"
cell_lab[names(cell_lab) %in% cells_with_no_neig] <- "нет соседей"
cell_lab[names(cell_lab) %in% cells_add_to_zero] <- "добавленные соседи"
cell_lab[!cell_lab %in% c("нет соседей", "добавленные соседи")] <- "соседи есть"

cono.t$plotGraph(groups=cell_lab, alpha=0.1, show.legend=TRUE)
cono.t$plotGraph(color.by='sample', alpha=0.1, show.legend=TRUE)
#length(cono.t$misc$tenX$`AAACATTGATCACG-1`)
matrix <- cono.t$embedding
cells <- tibble(cell = rownames(matrix))
annotation <- tibble(cell = names(ann$CellType), cellType = ann$CellType, old_name = ann$CellId, protocol = ann$Protocol)
# нужно переименовать часть клеток
f <- filter(annotation, str_detect(annotation$cell, "-1_GSM"))
f$cell <- strsplit(f$cell, "_GSM") %>% sapply(function(x) x[1])
annotation[str_detect(annotation$cell, "-1_GSM"),] <- f


annotation <- left_join(cells, annotation, by = "cell")
names(annotation$cellType) <- annotation$cell

annotation <- annotation[!duplicated(annotation$cell), ]
cono.t$plotGraph(groups=annotation$cellType, alpha=0.1, show.legend=TRUE)


#делаю цикл более 1 раза
cono.t$misc$neighborfilter <- NULL
cono.t$misc$add.cells <- TRUE
cono.t$misc$add.cells.k <- 2
cono.t$misc$add.cells.times <- 2
undebug(cono.t$buildGraph)
cono.t$buildGraph(k=30, k1 = 50, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = 0)

cono.t$findCommunities(method=leiden.community, resolution=1)
cono.t$embedGraph()
cono.t$plotGraph(color.by='sample', alpha=0.1, show.legend=TRUE)
cells_with_no_neig <- cono.t$misc$cells.zero[[2]]
cells_add_to_zero <- setdiff(cells_add_to_zero, cells_with_no_neig[[2]])

cell_lab <- rownames(cono.t$embedding)
names(cell_lab) <- rownames(cono.t$embedding)
#cell_lab <- "n"
cell_lab[names(cell_lab) %in% cells_with_no_neig[[2]]] <- "no_neig"
cell_lab[names(cell_lab) %in% cells_add_to_zero] <- "add_cells"
cell_lab[!cell_lab %in% c("no_neig", "add_cells")] <- "no_i"

cono.t$plotGraph(groups=cell_lab, alpha=0.1, show.legend=TRUE)
cono.t$plotGraph(color.by='sample', alpha=0.1, show.legend=TRUE)

ann.tiny1 <- fread("/home/kvergasova/conos_analysis/annotation_tiny_data.tsv")
g <- cono.t$graph
batch <- tibble(cell = names(V(g)))  
batch <- left_join(batch, ann.tiny1, by = "cell")

modularity(g, as.numeric(as.factor(batch$protocol)))
modularity(g, as.numeric(as.factor(batch$cellType)))

prot <- c( -0.01675243, -0.1836122)
cell <- c(0.4844675, 0.3035448)
nam <- c("без изменений", "добавление соседей")
df.plot <- tibble(nam, prot, cell)

ggplot(df.plot, aes(x = nam, group = 1)) + geom_line(aes(y = cell, color = 'клеточные типы'), color = 'green')+ geom_point(aes(y = cell), color = 'green')+ geom_line(aes(y = prot, color = 'протокол'), color = 'blue') + geom_point(aes(y = prot), color = 'blue') + ylab('модулярность') +  theme_bw() + theme(text = element_text(size=20))
```
#kbet loop
```{r}
# annotation <- tibble(cell = names(ann$CellType), cellType = ann$CellType, old_name = ann$CellId, protocol = ann$Protocol)
# # нужно переименовать часть клеток
# f <- filter(annotation, str_detect(annotation$cell, "-1_GSM"))
# f$cell <- strsplit(f$cell, "_GSM") %>% sapply(function(x) x[1])
# annotation[str_detect(annotation$cell, "-1_GSM"),] <- f
library(kBET)
library(conos)
# CalculateKBET <- function(matrix, annot.new){
#   
# }
#old conos
kBET_result_all <- list()
j<-1
for (i in c(0, 0.1, 0.3, 0.5, 0.8, 1)){
  cono.t$misc <- NULL
  cono.t$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = i)
  cono.t$findCommunities(method=leiden.community, resolution=1)
  cono.t$embedGraph()
  #cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
  #cono.tiny$plotGraph(alpha=0.1)
  matrix <- cono.t$embedding
  cells <- tibble(cell = rownames(matrix))

  annot.new <- left_join(cells, annotation, by = "cell")
  names(annot.new$cellType) <- annot.new$cell
  annot.new<- annot.new[!duplicated(annot.new$cell), ]
  #рисунок с аннотацией клеток
  save <- tibble(cell = rownames(cono.t$embeddings$largeVis),X = cono.t$embeddings$largeVis[,1], Y = cono.t$embeddings$largeVis[,2] ) 
  #cono.t$plotGraph(groups = annot.new$cellType, mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
  clusters.ann <- names(table(annot.new$cellType)[table(annot.new$cellType) > 70])
  fwrite(save, str_c("/home/kvergasova/conos_analysis/mouse_brain/data_shil/data_", i,".tsv"))

  #all(annotation$cell == save$cell)
  fwrite(tibble(unname( annot.new$cellType)), str_c("/home/kvergasova/conos_analysis/mouse_brain/data_shil/cell_labels_tiny_data_", i,".tsv"))
  fwrite(tibble(unname( annot.new$protocol)), str_c("/home/kvergasova/conos_analysis/mouse_brain/data_shil/protocol_tiny_data_", i,".tsv"))
#   kBET_res <- list()
#   kBET_result_list <- list()
#   for (cluster_level in clusters.ann){
#      batch_tmp <- annot.new$protocol[annot.new$cellType == cluster_level]
#      data_tmp <- matrix[rownames(matrix) %in% annot.new$cell[annot.new$cellType == cluster_level],]
#      kBET_tmp <- kBET(df=data_tmp, k0 = 15, batch=batch_tmp, plot=TRUE, do.pca = FALSE,  heuristic=FALSE, adapt=FALSE)
#      kBET_result_list[[cluster_level]] <- kBET_tmp
#      kBET_res[[cluster_level]] <- kBET_tmp$summary$kBET.observed[1]
#   }
# kBET_result_all[[j]] <- kBET_res
#   j <- j + 1
}

as.data.frame(kBET_result_all)


# g<-1
# for (n.neig in c(0.05, 0.1, 0.3, 0.5)){
#   pl <- list()
#   j <- 1
#   
#   cono.t$misc <- lapply(cono.t$samples, function(x) findCells(x, n.neig))
#   cono.t$misc$add.cells <- FALSE
#   for (i in c(0, 0.1, 0.3, 0.5, 0.8, 1)){
#     cono.t$buildGraph(k=50, k1 = 100, k.self=5, space='PCA', ncomps=30, n.odgenes=2000, matching.method='mNN', metric='angular', score.component.variance=TRUE, verbose=TRUE,  alignment.strength = i)
#     cono.t$findCommunities(method=leiden.community, resolution=1)
#     cono.t$embedGraph()
#     #cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
#     #cono.tiny$plotGraph(alpha=0.1)
#     pl[[j]] <- cono.t$plotGraph(color.by='sample', mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
#     j <- j + 1
#   }
#   pl.list[[g]] <- pl
#   g <- g+1
# }
# 
# 



# matrix <- cono.t$embedding
# cells <- tibble(cell = rownames(matrix))
# 
# annot.new <- left_join(cells, annotation, by = "cell")
# names(annot.new$cellType) <- annot.new$cell
# annot.new<- annot.new[!duplicated(annot.new$cell), ]
# #рисунок с аннотацией клеток
# 
# cono.t$plotGraph(groups = annot.new$cellType, mark.groups=FALSE, alpha=0.1, show.legend=TRUE)
# clusters.ann <- names(table(annot.new$cellType)[table(annot.new$cellType) > 70])
# kBET_res <- list()
# kBET_result_list <- list()
# for (cluster_level in clusters.ann){
#    batch_tmp <- annotation$protocol[annotation$cellType == cluster_level]
#    data_tmp <- matrix[rownames(matrix) %in%  annotation$cell[annotation$cellType == cluster_level],]
#    kBET_tmp <- kBET(df=data_tmp, k0 = 15, batch=batch_tmp, plot=TRUE, do.pca = FALSE,  heuristic=FALSE, adapt=FALSE)
#    kBET_result_list[[cluster_level]] <- kBET_tmp
#    kBET_res[[cluster_level]] <- kBET_tmp$summary$kBET.observed[1]
# }

kbet_table <- sapply(kBET_result_all, as.data.frame)
colnames(kbet_table) <- c("0", "0.1", "0.3", "0.5", "0.8", "1")
kbet_table
#library(data.table)
save <- tibble(cell = rownames(cono.t$embeddings$largeVis),X = cono.t$embeddings$largeVis[,1], Y = cono.t$embeddings$largeVis[,2] )

fwrite(save, "/home/kvergasova/conos_analysis/tiny_pca.tsv")

all(annotation$cell == save$cell)
fwrite(tibble(unname(annotation$cellType)), "/home/kvergasova/conos_analysis/cell_labels_tiny_data.tsv")
fwrite(tibble(unname(annotation$protocol)), "/home/kvergasova/conos_analysis/protocol_tiny_data.tsv")
```

